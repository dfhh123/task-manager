# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ User Service

User Service –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Spring –ø—Ä–æ—Ñ–∏–ª–∏:

## üîß –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏

### 1. –ü—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`default` –∏–ª–∏ –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è)
**–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**

- **–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –ø—Ä–æ—Ñ–∏–ª—å `keycloak`
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
  - `SecurityConfig` - –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  - `JwtConfig` - JWT encoder/decoder —Å —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–º –∫–ª—é—á–æ–º
  - `AuthController` - endpoints –¥–ª—è –ª–æ–≥–∏–Ω–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  - `JwtService` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤

- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: `application.yml` –∏–ª–∏ `application-local.yml`
- **–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á**: `app.jwt.secret`

### 2. –ü—Ä–æ—Ñ–∏–ª—å `keycloak`
**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Keycloak**

- **–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è**: –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ `spring.profiles.active=keycloak`
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
  - `KeycloakSecurityConfig` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Keycloak OAuth2 Resource Server
  - `KeycloakAuthController` - endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Keycloak
  - `KeycloakUserStorageProvider` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–∑–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - `UserAdapter` - –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: `user-service-keycloak.yml`
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Keycloak**: `keycloak.url`, `keycloak.realm`, `keycloak.client-id`

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ó–∞–ø—É—Å–∫ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π:
```bash
# –ß–µ—Ä–µ–∑ application.yml (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
java -jar user-service.jar

# –ò–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
java -jar user-service.jar --spring.profiles.active=default
```

### –ó–∞–ø—É—Å–∫ —Å Keycloak:
```bash
java -jar user-service.jar --spring.profiles.active=keycloak
```

### –ß–µ—Ä–µ–∑ Docker:
```bash
# –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è JWT
docker run -e SPRING_PROFILES_ACTIVE=default user-service

# Keycloak
docker run -e SPRING_PROFILES_ACTIVE=keycloak user-service
```

## üìã Endpoints

### –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π JWT (`default`):
- `POST /api/v1/auth/login` - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /api/v1/auth/register` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `GET /api/v1/rest/users/**` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Keycloak (`keycloak`):
- `POST /api/v1/auth/register` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î)
- `GET /api/v1/auth/user/{id}` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `PUT /api/v1/auth/user/{id}` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /api/v1/rest/users/**` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—á–µ—Ä–µ–∑ Keycloak —Ç–æ–∫–µ–Ω—ã)

## üîê –†–æ–ª–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

–û–±–∞ –ø—Ä–æ—Ñ–∏–ª—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Ä–æ–ª–µ–π:
- `USER` - –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∞
- `MODERATOR` - –º–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞  
- `ADMIN` - –ø–æ–ª–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∞

### –ú–∞–ø–ø–∏–Ω–≥ —Ä–æ–ª–µ–π:
- **–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è JWT**: —Ä–æ–ª–∏ –≤ –ø–æ–ª–µ `scope` JWT —Ç–æ–∫–µ–Ω–∞
- **Keycloak**: —Ä–æ–ª–∏ –≤ –ø–æ–ª–µ `scope` JWT —Ç–æ–∫–µ–Ω–∞ (–∏–∑ Keycloak)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SecurityProfileTest`:

```bash
# –¢–µ—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
./gradlew test --tests SecurityProfileTest#testDefaultSecurityProfile

# –¢–µ—Å—Ç Keycloak –ø—Ä–æ—Ñ–∏–ª—è  
./gradlew test --tests SecurityProfileTest#testKeycloakSecurityProfile
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### application.yml (—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è JWT):
```yaml
app:
  jwt:
    secret: your-secret-key-here
```

### user-service-keycloak.yml (Keycloak):
```yaml
keycloak:
  url: http://localhost:8080
  realm: event-platform
  client-id: user-service
  client-secret: your-client-secret
```

## üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ—Ñ–∏–ª—è–º–∏

–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è:
- `@Profile("!keycloak")` –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π JWT
- `@Profile("keycloak")` –Ω–∞ Keycloak –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
- `@Primary` –Ω–∞ Keycloak –±–∏–Ω–∞—Ö –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

–ú–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞.
